<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Testda qatnashganlar ro'yxati</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons (ixtiyoriy, lekin pro ko‘rinish uchun foydali) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px;
            background-color: #f6f7f9;
        }
        .navbar {
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .section-card {
            border: 1px solid #e9ecef;
            border-radius: 14px;
            background: #fff;
            box-shadow: 0 6px 16px rgba(16,24,40,0.04);
        }
        .section-card .card-header {
            border-bottom: 1px solid #eef1f4;
            font-weight: 600;
            letter-spacing: .2px;
        }
        .student-item {
            border: 1px solid #eef1f4;
            border-radius: 12px;
            transition: box-shadow .18s ease;
        }
        .student-item:hover {
            box-shadow: 0 4px 14px rgba(16,24,40,0.06);
        }
        .avatar-40 {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #344054;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            padding: .25rem .55rem;
            border: 1px solid #e5e7eb;
            background: #fafafa;
            border-radius: 999px;
            font-size: .75rem;
            color: #475467;
        }
        .metric {
            font-size: .75rem;
            color: #475467;
            background: #f8fafc;
            border: 1px solid #eef2f7;
            border-radius: 8px;
            padding: .3rem .5rem;
            margin-right: .35rem;
        }
        .score-badge {
            font-weight: 600;
            background: #f3f4f6;
            color: #111827;
        }
        .btn-outline-success {
            --bs-btn-color: #198754;
            --bs-btn-border-color: #19875433;
        }
        .btn-outline-success:disabled,
        .btn-outline-success.is-done {
            opacity: .8;
            cursor: default;
        }
        .progress {
            height: 10px;
            background: #eef2f7;
        }
        .progress-bar {
            background: #16a34a;
        }
        /* Toast joylashuvi */
        .toast-container {
            z-index: 1100;
        }
    </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#">
            <i class="bi bi-speedometer2 me-2"></i>Controller Panel
        </a>
        <div class="d-flex">
            <a href="/api/controller-panel/dashboard/" class="btn btn-outline-light">
                <i class="bi bi-house-door me-1"></i> Dashboard
            </a>
        </div>
    </div>
</nav>

<!-- Toast (muvaffaqiyat xabari) -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                ♻️ Qayta topshirishga ruxsat berildi.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Yopish"></button>
        </div>
    </div>
</div>

<div class="container mt-4">
    <!-- CSRF token yashirin input (AJAX uchun) -->
    <input type="hidden" id="csrfToken" value="{{ csrf_token }}">


    <div class="d-flex align-items-center mb-4">
        <i class="bi bi-people-fill fs-2 text-primary me-2"></i>
        <h2 class="mb-0 fw-bold">Testda qatnashganlar ro'yxati</h2>
    </div>

    {% for group, students in group_data.items %}
    <div class="card section-card mb-4 shadow-sm border-0">
        <div class="card-header bg-primary bg-opacity-10 text-primary fw-bold fs-5 border-0">
            <i class="bi bi-people me-2"></i>{{ group.name }} <span class="text-muted fs-6">(Guruh)</span>
        </div>
        <div class="card-body">
            {% for student, tests in students.items %}
            <div class="mb-4">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="avatar-40 bg-primary bg-opacity-25 text-primary">{{ student.get_full_name|slice:":1" }}</div>
                    <div>
                        <div class="fw-semibold fs-6 mb-1">{{ student.get_full_name }}</div>
                        <span class="badge bg-light text-secondary border">Talaba</span>
                    </div>
                </div>
                <div class="table-responsive mt-2">
                    <table class="table table-bordered table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fan</th>
                                <th>Semestr</th>
                                <th>Ball</th>
                                <th>Savollar</th>
                                <th>To'g'ri javoblar</th>
                                <th>Natija (%)</th>
                                <th>Qayta topshirish</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for st in tests %}
                            <tr>
                                <td>{{ st.test.subject.name }}</td>
                                <td>{% if st.semester %}{{ st.semester.number }}{% else %}-{% endif %}</td>
                                <td>{{ st.total_score|floatformat:2 }}/{{ st.test.total_score }}</td>
                                <td>{{ st.question_ids|length }}</td>
                                <td>{{ st.correct_answers_count|default:'?' }}</td>
                                <td>{% if st.percent_result is not None %}{{ st.percent_result }}{% else %}-{% endif %}</td>
                                <td>
                                    {% if not st.can_retake %}
                                        <button class="btn btn-sm btn-outline-success allow-retake-btn d-inline-flex align-items-center gap-1" data-stest-id="{{ st.id }}">
                                            <i class="bi bi-arrow-repeat"></i> Ruxsat berish
                                        </button>
                                    {% else %}
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}


</div>

<!-- Modal -->
<div class="modal fade" id="retakeModal" tabindex="-1" aria-labelledby="retakeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="retakeModalLabel">Qayta topshirishga ruxsat berish</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Yopish"></button>
      </div>
      <div class="modal-body">
        <input type="password" id="retakePassword" class="form-control" placeholder="Parolni kiriting">
        <input type="hidden" id="retakeStestId">
        <div class="invalid-feedback mt-2" id="retakeError"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Bekor qilish</button>
        <button type="button" class="btn btn-primary" id="confirmRetakeBtn">
            <span class="default-label">Tasdiqlash</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function() {
    // Modalni ochish: qaysi item bosilgani eslab qolamiz
    let currentTriggerBtn = null;

    function getCSRFToken() {
        const hidden = document.getElementById('csrfToken')?.value;
        if (hidden && hidden !== 'NOTPROVIDED') return hidden;
        // Cookie'dan olish (fallback)
        const match = document.cookie.split('; ').find(r => r.startsWith('csrftoken='));
        return match ? match.split('=')[1] : '';
    }

    document.querySelectorAll('.allow-retake-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            currentTriggerBtn = btn;
            document.getElementById('retakeStestId').value = btn.getAttribute('data-stest-id');
            document.getElementById('retakePassword').value = '';
            document.getElementById('retakeError').textContent = '';
            document.getElementById('retakePassword').classList.remove('is-invalid');

            const modal = new bootstrap.Modal(document.getElementById('retakeModal'));
            modal.show();
        });
    });

    const confirmBtn = document.getElementById('confirmRetakeBtn');
    confirmBtn.addEventListener('click', function() {
        const stestId = document.getElementById('retakeStestId').value;
        const password = document.getElementById('retakePassword').value;
        const errorEl = document.getElementById('retakeError');
        const pwdEl = document.getElementById('retakePassword');

        // UI: loading holat
        confirmBtn.disabled = true;
        confirmBtn.querySelector('.spinner-border').classList.remove('d-none');
        errorEl.textContent = '';
        pwdEl.classList.remove('is-invalid');

        fetch("{% url 'allow_retake' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCSRFToken()
            },
            body: 'stest_id=' + encodeURIComponent(stestId) + '&password=' + encodeURIComponent(password)
        })
        .then(response => response.json())
        .then(data => {
            // Loading off
            confirmBtn.disabled = false;
            confirmBtn.querySelector('.spinner-border').classList.add('d-none');

            if (data.success) {
                // Modalni yopish
                const modalEl = document.getElementById('retakeModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Toast ko‘rsatish
                const toastEl = document.getElementById('successToast');
                const toast = new bootstrap.Toast(toastEl, { delay: 2200 });
                toast.show();

                // UI yangilash: sahifani to'liq yangilaymiz, shunda can_retake backenddan to'g'ri keladi
                window.location.reload();
            } else {
                errorEl.textContent = data.error || 'Xatolik yuz berdi';
                pwdEl.classList.add('is-invalid');
            }
        })
        .catch(() => {
            confirmBtn.disabled = false;
            confirmBtn.querySelector('.spinner-border').classList.add('d-none');
            errorEl.textContent = 'Tarmoq xatosi. Qayta urinib ko‘ring.';
            pwdEl.classList.add('is-invalid');
        });
    });

    // Enter bosilganda tasdiqlash
    document.getElementById('retakePassword').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            confirmBtn.click();
        }
    });
})();
</script>
</body>
</html>
