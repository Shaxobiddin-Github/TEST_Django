<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Foydalanuvchilarni boshqarish</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f6f8fa; font-family: 'Inter', 'Segoe UI', sans-serif; }
        .user-card { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(102,126,234,0.07); padding: 32px 28px; margin-bottom: 32px; }
        .user-table th, .user-table td { vertical-align: middle; }
        .user-table th { background: #f0f4fa; }
        .user-table tr:nth-child(even) { background: #f9fafb; }
        .form-label { font-weight: 600; }
        .form-section-title { font-size: 1.3rem; font-weight: 700; color: #4f46e5; margin-bottom: 18px; }
        .btn-add { background: linear-gradient(90deg,#667eea,#4f46e5); color: #fff; font-weight: 600; border-radius: 10px; padding: 10px 28px; }
        .btn-add:hover { background: linear-gradient(90deg,#4f46e5,#667eea); }
    </style>
</head>
<body>
<nav style="position:fixed;top:0;left:0;width:100%;z-index:1000;background:linear-gradient(90deg,#667eea,#4f46e5);box-shadow:0 2px 8px rgba(0,0,0,0.07);padding:12px 0;">
    <div class="container d-flex justify-content-between align-items-center">
        <span style="color:#fff;font-weight:700;font-size:1.2rem;letter-spacing:1px;">Controller Admin Panel</span>
        <a href="/api/controller-panel/dashboard/" class="btn btn-light" style="font-weight:600;">üè† Controller panelga qaytish</a>
    </div>
</nav>
<div class="container py-5" style="margin-top:70px;">
    
    <div class="user-card mb-4">
        <div class="form-section-title mb-3">Yangi foydalanuvchi qo'shish</div>
        <form method="post" autocomplete="off">
            {% csrf_token %}
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label for="first_name" class="form-label">Ism</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" required>
                </div>
                <div class="col-md-2">
                    <label for="last_name" class="form-label">Familiya</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" required>
                </div>
                <div class="col-md-2">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="col-md-2">
                    <label for="password" class="form-label">Parol</label>
                    <input type="text" class="form-control" id="password" name="password" required>
                </div>
                <div class="col-md-2">
                    <label for="role" class="form-label">Roli</label>
                    <select class="form-select" id="role" name="role" required onchange="showRoleFields()">
                        <option value="">Tanlang...</option>
                        {% for value, label in role_choices %}
                            {% if value != 'admin' %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2" id="groupField" style="display:none;">
                    <label for="group" class="form-label">Guruh</label>
                    <select class="form-select" id="group" name="group">
                        <option value="">Tanlang...</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2" id="kafedraField" style="display:none;">
                    <label for="kafedra" class="form-label">Kafedra</label>
                    <select class="form-select" id="kafedra" name="kafedra">
                        <option value="">Tanlang...</option>
                        {% for kafedra in kafedralar %}
                        <option value="{{ kafedra.id }}">{{ kafedra.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2" id="bulimField" style="display:none;">
                    <label for="bulim" class="form-label">Bo'lim</label>
                    <select class="form-select" id="bulim" name="bulim">
                        <option value="">Tanlang...</option>
                        {% for bulim in bulimlar %}
                        <option value="{{ bulim.id }}">{{ bulim.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-add">Qo'shish</button>
                </div>
            </div>
        </form>
    </div>
    <div class="user-card mb-4">
        <div class="form-section-title mb-3">Foydalanuvchilarni filtrlash</div>
        <form method="get" id="filterForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="filter_role" class="form-label">Roli</label>
                    <select class="form-select" id="filter_role" name="filter_role" onchange="this.form.submit()">
                        <option value="">Barchasi</option>
                        {% for value, label in role_choices %}
                            {% if value != 'admin' %}
                            <option value="{{ value }}" {% if request.GET.filter_role == value %}selected{% endif %}>{{ label }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_group" class="form-label">Guruh</label>
                    <select class="form-select" id="filter_group" name="filter_group" onchange="this.form.submit()">
                        <option value="">Barchasi</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}" {% if request.GET.filter_group == group.id|stringformat:'s' %}selected{% endif %}>{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_kafedra" class="form-label">Kafedra</label>
                    <select class="form-select" id="filter_kafedra" name="filter_kafedra" onchange="this.form.submit()">
                        <option value="">Barchasi</option>
                        {% for kafedra in kafedralar %}
                        <option value="{{ kafedra.id }}" {% if request.GET.filter_kafedra == kafedra.id|stringformat:'s' %}selected{% endif %}>{{ kafedra.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_bulim" class="form-label">Bo'lim</label>
                    <select class="form-select" id="filter_bulim" name="filter_bulim" onchange="this.form.submit()">
                        <option value="">Barchasi</option>
                        {% for bulim in bulimlar %}
                        <option value="{{ bulim.id }}" {% if request.GET.filter_bulim == bulim.id|stringformat:'s' %}selected{% endif %}>{{ bulim.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>
    <div class="user-card">
        <div class="form-section-title mb-3">Barcha foydalanuvchilar (superuserlarsiz)</div>
        <div class="d-flex align-items-center mb-2 gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" id="showAllAccessBtn">Barcha access code-ni ko‚Äòrish</button>
            <a href="{% url 'export_users_excel' %}?filter_role={{ request.GET.filter_role }}&filter_group={{ request.GET.filter_group }}&filter_kafedra={{ request.GET.filter_kafedra }}&filter_bulim={{ request.GET.filter_bulim }}" class="btn btn-success btn-sm">Excelga yuklash</a>
            <a href="{% url 'export_users_word' %}?filter_role={{ request.GET.filter_role }}&filter_group={{ request.GET.filter_group }}&filter_kafedra={{ request.GET.filter_kafedra }}&filter_bulim={{ request.GET.filter_bulim }}" class="btn btn-primary btn-sm">Wordga yuklash</a>
            <a href="{% url 'export_users_pdf' %}?filter_role={{ request.GET.filter_role }}&filter_group={{ request.GET.filter_group }}&filter_kafedra={{ request.GET.filter_kafedra }}&filter_bulim={{ request.GET.filter_bulim }}" class="btn btn-danger btn-sm">PDFga yuklash</a>
        </div>
        <div class="table-responsive">
            <table class="table user-table table-bordered table-hover">
                <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ism</th>
                            <th>Familiya</th>
                            <th>Username</th>
                            <th>Roli</th>
                            <th>Guruh</th>
                            <th>Kafedra</th>
                            <th>Bo'lim</th>
                            <th>Access code</th>
                        </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.first_name }}</td>
                        <td>{{ user.last_name }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.get_role_display }}</td>
                        <td>{% if user.group %}{{ user.group.name }}{% endif %}</td>
                        <td>{% if user.kafedra %}{{ user.kafedra.name }}{% endif %}</td>
                        <td>{% if user.bulim %}{{ user.bulim.name }}{% endif %}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary show-access-btn" data-access="{{ user.access_code }}">Access code-ni ko‚Äòrish</button>
                            <span class="access-code-value d-none ms-2">{{ user.access_code }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
// Barcha access code-ni ko‚Äòrish uchun parol so‚Äòrash va har bir user uchun alohida ko‚Äòrish
document.addEventListener('DOMContentLoaded', function() {
    var showAllBtn = document.getElementById('showAllAccessBtn');
    if (showAllBtn) {
        showAllBtn.addEventListener('click', function() {
            var parol = prompt("Barcha access code-ni ko‚Äòrish uchun parolni kiriting:");
            if (parol === '96970204') {
                document.querySelectorAll('.access-code-value').forEach(function(el) {
                    el.classList.remove('d-none');
                });
                showAllBtn.classList.remove('btn-outline-primary');
                showAllBtn.classList.add('btn-success');
                showAllBtn.textContent = 'Access code-lar ko‚Äòrinmoqda';
            } else if (parol !== null) {
                alert('Parol noto‚Äòg‚Äòri!');
            }
        });
    }

    // Export tugmalar uchun parol logikasi
    function exportWithPassword(selector, failMsg) {
        document.querySelectorAll(selector).forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                var parol = prompt("Yuklab olish uchun parolni kiriting:");
                if (parol !== '96970204') {
                    e.preventDefault();
                    if (parol !== null) alert(failMsg);
                }
            });
        });
    }
    exportWithPassword('a.btn-success', 'Excel yuklash uchun parol noto‚Äòg‚Äòri!');
    exportWithPassword('a.btn-primary', 'Word yuklash uchun parol noto‚Äòg‚Äòri!');
    exportWithPassword('a.btn-danger', 'PDF yuklash uchun parol noto‚Äòg‚Äòri!');
    document.querySelectorAll('.show-access-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var parol = prompt("Access code-ni ko‚Äòrish uchun parolni kiriting:");
            if (parol === '96970204') {
                btn.nextElementSibling.classList.remove('d-none');
                btn.remove();
            } else if (parol !== null) {
                alert('Parol noto‚Äòg‚Äòri!');
            }
        });
    });
    // Sahifa yuklanganda ham role maydoniga qarab mos fieldlarni ko‚Äòrsatish
    showRoleFields();
});
function showRoleFields() {
    var role = document.getElementById('role').value;
    document.getElementById('groupField').style.display = (role === 'student') ? '' : 'none';
    document.getElementById('kafedraField').style.display = (role === 'tutor') ? '' : 'none';
    document.getElementById('bulimField').style.display = (role === 'employee') ? '' : 'none';
}
</script>
</body>
</html>
